
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multi‑Currency Price List</title>

  <!-- Load your BC SoftWear–aligned stylesheet -->
  styles.css
</head>
<body>
  <!-- Status / diagnostics appear here (populated by JS) -->
  <div id="status" style="margin:10px 0; color:#333;"></div>

  <header>
    <h1>Multi‑Currency Price List</h1>
    <p class="note">
      Base currency = GBP. Rates are static (from <code>Createrates.json</code>) unless overridden below.
    </p>

    <div class="controls">
      <div>
        <label for="currency">Display currency:</label>
        <select id="currency"></select>
      </div>
      <button id="download">Download current table (CSV)</button>
    </div>

    <details style="margin-top:10px;">
      <summary>Override rates manually</summary>
      <div class="rate-inputs" id="rateInputs"></div>
      <button id="applyRates">Apply overrides</button>
    </details>
  </header>

  <table id="prices">
    <thead>
      <tr>
        <th>ID</th><th>Name</th><th>SKU</th><th>GBP</th><th id="dynHead">Converted</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // ---------------- UI helpers ----------------
    function showStatus(msg, type = 'info') {
      const el = document.getElementById('status');
      el.style.color = (type === 'error') ? '#b00020' : '#333';
      el.innerHTML = msg || '';
    }

    function fmt(n, decimals = 2) {
      const x = Number(n);
      if (!isFinite(x)) return '—';
      return x.toLocaleString(undefined, {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    // Optional: currency-specific rounding (add more rules if needed)
    function roundFor(cur, amount) {
      if (cur === 'AED' || cur === 'JPY') return Math.round(amount); // whole units
      return Number(amount.toFixed(2)); // default 2dp
    }

    // ---------------- App state ----------------
    const state = { base: 'GBP', rates: {}, data: [] };

    // ---------------- Load data ----------------
    async function load() {
      try {
        showStatus('Loading data…');
        const [pricesText, ratesJson] = await Promise.all([
          fetch('prprice-list.csv').then(r => {
            if (!r.ok) throw new Error('Could not load prprice-list.csv (' + r.status + ')');
            return r.text();
          }),
          fetch('Createrates.json').then(r => {
            if (!r.ok) throw new Error('Could not load Createrates.json (' + r.status + ')');
            return r.json();
          })
        ]);

        // Validate JSON structure
        if (!ratesJson || typeof ratesJson !== 'object' || !ratesJson.rates) {
          throw new Error('Createrates.json is missing a "rates" object.');
        }

        // Parse CSV -> array of objects
        const rows = csvToJson(pricesText);
        if (!rows.length) throw new Error('CSV parsed but contains no data rows.');
        if (!rows[0].hasOwnProperty('Price_GBP')) {
          throw new Error('CSV header must include "Price_GBP". Header should be: ID,Name,SKU,Price_GBP');
        }

        // Ensure Price_GBP is numeric (no "£" symbol in CSV values)
        const bad = rows.filter(r => !isFinite(parseFloat(r.Price_GBP)));
        if (bad.length) {
          console.warn('Non-numeric Price_GBP rows (first 3):', bad.slice(0,3));
          throw new Error('One or more Price_GBP values are not numeric. In the CSV, use values like 43.08 (no £).');
        }

        // Save to state
        state.base  = ratesJson.base || 'GBP';
        state.rates = ratesJson.rates;
        state.data  = rows.map(r => ({
          ID: r.ID,
          Name: r.Name,
          SKU: r.SKU,
          Price_GBP: parseFloat(r.Price_GBP)
        }));

        // Optional: show date if present in JSON
        if (ratesJson.date) {
          const noteEl = document.querySelector('.note');
          noteEl.innerHTML =
            `Base currency = ${state.base}. Rates are static (from <code>Createrates.json</code>) — last updated <strong>${ratesJson.date}</strong>.`;
        }

        initUI();
        render();
        showStatus(''); // clear
      } catch (err) {
        console.error(err);
        showStatus('⚠️ ' + err.message + ' — open browser console for details.', 'error');
      }
    }

    // Simple CSV parser (works for simple CSV without quoted commas).
    // If your product names contain commas, I can switch this to a quoted-CSV parser for you.
    function csvToJson(csv) {
      const lines = csv.trim().split(/\r?\n/);
      if (!lines.length) return [];
      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const cols = line.split(',');
        const o = {};
        headers.forEach((h,i) => o[h] = (cols[i] ?? '').trim());
        return o;
      });
    }

    // ---------------- UI wiring ----------------
    function initUI() {
      // Currency dropdown
      const sel = document.getElementById('currency');
      sel.innerHTML = Object.keys(state.rates)
        .map(c => `<option value="${c}">${c}</option>`)
        .join('');
      sel.value = 'GBP';
      sel.onchange = render;

      // Manual rate overrides
      const box = document.getElementById('rateInputs');
      box.innerHTML = Object.entries(state.rates)
        .map(([c,r]) => `<label>${c}: <input type="number" step="0.0001" value="${r}" data-cur="${c}" /></label>`)
        .join('');
      document.getElementById('applyRates').onclick = () => {
        document.querySelectorAll('#rateInputs input').forEach(inp => {
          const cur = inp.dataset.cur, val = parseFloat(inp.value);
          if (isFinite(val)) state.rates[cur] = val;
        });
        render();
      };

      // Download CSV of the rendered table
      document.getElementById('download').onclick = () => {
        const cur  = document.getElementById('currency').value || 'GBP';
        const rows = state.data.map(r => {
          const conv = roundFor(cur, r.Price_GBP * (state.rates[cur] || 1));
          return [r.ID, r.Name, r.SKU, fmt(r.Price_GBP), fmt(conv)];
        });
        const csvOut = ['ID,Name,SKU,GBP,' + cur]
          .concat(rows.map(x => x.join(',')))
          .join('\n');
        const blob = new Blob([csvOut], { type: 'text/csv' });
        const a    = document.createElement('a');
        a.href     = URL.createObjectURL(blob);
        a.download = `price_list_${cur}.csv`;
        a.click();
      };
    }

    function render() {
      const cur = document.getElementById('currency').value || 'GBP';
      document.getElementById('dynHead').textContent = `Converted (${cur})`;

      const tbody = document.querySelector('#prices tbody');
      tbody.innerHTML = state.data.map(r => {
        const conv = roundFor(cur, r.Price_GBP * (state.rates[cur] || 1));
        return `
          <tr>
            <td data-label="ID">${r.ID}</td>
